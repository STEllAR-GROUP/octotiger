version: 2
jobs:
    build:
        docker:
            - image: prsam/octotiger:base_image
        working_directory: /
        steps:
            - checkout:
                path: /octotiger
            - run:
                name: Configure Octotiger
                command: |
                    cmake -Hoctotiger -Boctotiger/build \
                          -DCMAKE_BUILD_TYPE=Release \
                          -DHPX_DIR=/local/hpx/lib/cmake/HPX \
                          -DVc_DIR=/local/vc/lib/cmake/Vc \
                          -DSilo_DIR=/local/silo \
                          -DHDF5_INCLUDE_DIR=/local/hdf5/include \
                          -DHDF5_LIBRARY=/local/hdf5/lib/libhdf5.so \
                          -DBOOST_ROOT=/local/boost \
                          -GNinja
            - run:
                name: Build
                command: cmake --build octotiger/build -- -j2
            - save_cache:
                key: v5-build-{{ .Branch }}-{{ .Revision }}
                paths:
                    - /octotiger/build

    test:
        docker:
            - image: prsam/octotiger:base_image
        environment:
            LD_LIBRARY_PATH: /local/hdf5/lib:/local/boost_1_63_0/lib:/local/hpx/lib:/local/Vc/lib
        steps:
            - checkout:
                path: /octotiger
            - restore_cache:
                key: v5-build-{{ .Branch }}-{{ .Revision }}
            - run: |
                cd /octotiger/test_problems/blast
                ./test.sh ../../build/octotiger /local/silo/bin/silodiff
            - run: |
                cd /octotiger/test_problems/sod
                ./test.sh ../../build/octotiger /local/silo/bin/silodiff
            - run: |
                /octotiger/build/octotiger --problem=moving_star --max_level=2 --xscale=32 --odt=0.5 --stop_step=0 --hpx:threads=1 --hpx:bind=none --compress_silo=off
            - run: |
                cd /octotiger/test1
                ./test1.sh > output.txt
            - run: |
                cd /octotigertest1
                python validate.py output.txt test1.txt
            #- run: |
            #    cd /octotigertools
            #    tar xzf restart7.chk.tar.gz

workflows:
    version: 2
    build_and_test:
        jobs:
            - build
            - test:
                requires:
                    - build
